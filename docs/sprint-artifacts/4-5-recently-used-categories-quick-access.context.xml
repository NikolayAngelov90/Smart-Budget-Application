<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>4</epicId>
    <storyId>5</storyId>
    <title>Recently-Used Categories Quick Access</title>
    <status>drafted</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/4-5-recently-used-categories-quick-access.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>my recently-used categories shown first in the transaction entry dropdown</iWant>
    <soThat>I can select common categories faster</soThat>
    <tasks>
      - Update GET /api/categories to support recent usage queries
      - Implement recent categories query in SQL (with JOIN to categories table)
      - Update transaction entry modal category dropdown to show recent section
      - Add divider line between recent and all categories sections
      - Implement color dots in both recent and all category sections
      - Add recent category limit (5 most recent)
      - Test edge cases: few/no transactions, only recent categories available
      - Implement cache invalidation after transaction creation
      - Test mobile responsiveness and touch targets
      - Ensure keyboard accessibility (Tab/arrow navigation)
      - Performance test: avoid expensive queries in modal opening path
    </tasks>
  </story>

  <acceptanceCriteria>
    - **Given** I open the transaction entry modal **When** I view the category dropdown **Then** My 5 most recently-used categories are shown at the top
    - **And** "Recent" section appears first in dropdown, separated by gray divider line
    - **And** Shows last 5 categories used in transactions (most recent first, based on transaction created_at)
    - **And** Each recent category shows color dot (8px) + name (regular font weight)
    - **And** "All Categories" section below shows all categories alphabetically
    - **And** Predefined and custom categories both included in "All" section
    - **And** If fewer than 5 categories used, show all recent ones (no minimum)
    - **And** New users with no transactions see only "All Categories" section (no recent section)
    - **And** Recent categories updated immediately after saving a transaction
    - **And** Recent list computed from transaction history (not stored separately for sync across devices)
    - **And** Selecting recent category same behavior as selecting from full list
    - **And** Hover/click behavior consistent between recent and all sections
    - **And** Mobile: recent categories large enough to tap easily (44x44px touch target on list items)
    - **And** Keyboard navigation: Tab moves between sections, arrow keys navigate within sections
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification - Category Management</title>
        <section>Recently-Used Tracking Strategy (lines 83-88)</section>
        <snippet>Note: Tech spec suggests localStorage for client-side tracking, but Story 4.5 ACs specify computing from transaction history for multi-device sync. Use server-side query approach instead.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-4.md</path>
        <title>Epic 4 Technical Specification - Category Management</title>
        <section>Services and Modules (lines 76-81)</section>
        <snippet>CategorySelector Component: Quick category picker with recently-used. Transaction type filter as input, returns selected category_id.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/components/categories/CategoryMenu.tsx</path>
        <kind>component</kind>
        <symbol>CategoryMenu</symbol>
        <lines>1-150</lines>
        <reason>CRITICAL: CategoryMenu component ALREADY IMPLEMENTED in Story 4-4 with recentCategories prop support! Shows recent section at top with divider, color dots via CategoryBadge, 44px touch targets. This story just needs to POPULATE the recentCategories data from API.</reason>
      </artifact>
      <artifact>
        <path>src/components/transactions/TransactionEntryModal.tsx</path>
        <kind>modal component</kind>
        <symbol>TransactionEntryModal</symbol>
        <lines>307-309, 388-396</lines>
        <reason>TransactionEntryModal already uses CategoryMenu and filters categories by type. Currently passes recentCategories from .filter((cat) => cat.last_used_at). Need to update to fetch from API query instead.</reason>
      </artifact>
      <artifact>
        <path>src/app/api/categories/route.ts</path>
        <kind>API route</kind>
        <symbol>GET handler</symbol>
        <lines>1-70</lines>
        <reason>Existing GET /api/categories endpoint returns categories filtered by type. Need to ADD recent usage query by joining with transactions table to compute top 5 most recent.</reason>
      </artifact>
      <artifact>
        <path>src/components/categories/CategoryBadge.tsx</path>
        <kind>component</kind>
        <symbol>CategoryBadge</symbol>
        <lines>1-180</lines>
        <reason>CategoryBadge with 'dot' variant already used in CategoryMenu (Story 4-4). Provides 8px color dots + category names as required by AC.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package>@chakra-ui/react</package>
        <version>^2.8.0</version>
        <use>Menu component with MenuGroup and MenuDivider already in CategoryMenu</use>
      </node>
      <node>
        <package>@supabase/supabase-js</package>
        <version>^2.81.1</version>
        <use>Supabase query with .order() and .limit() for recent categories from transactions</use>
      </node>
      <node>
        <package>swr</package>
        <version>^2.3.6</version>
        <use>SWR cache invalidation after transaction creation (mutate)</use>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>CategoryMenu component ALREADY has recentCategories prop - no UI changes needed! Only need to populate data from API.</constraint>
    <constraint>Query must compute recent categories from transaction history (SELECT DISTINCT category_id FROM transactions WHERE user_id = X ORDER BY created_at DESC LIMIT 5)</constraint>
    <constraint>Must JOIN with categories table to get category names and colors for recent list</constraint>
    <constraint>Performance: Index on transactions.created_at and transactions.user_id already exists (from Epic 3)</constraint>
    <constraint>Cache invalidation: TransactionEntryModal already uses mutate() after success - just need to invalidate categories cache too</constraint>
    <constraint>New users with no transactions: Query returns empty array for recentCategories, CategoryMenu handles gracefully (no recent section shown)</constraint>
    <constraint>Color dots and touch targets: Already implemented in CategoryMenu via CategoryBadge (8px dots, 44px menu items)</constraint>
    <constraint>Keyboard navigation: Already supported by Chakra UI Menu component (Arrow keys, Enter, Escape)</constraint>
    <constraint>Mobile responsiveness: CategoryMenu already responsive (full-width button, scrollable list)</constraint>
    <constraint>Story 4-4 implementation NOTE: CategoryMenu expects recentCategories prop with Category[] type matching main categories</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /api/categories?type=expense&recent=true</name>
      <kind>REST API endpoint</kind>
      <signature>GET /api/categories?type={income|expense}&recent={true|false}</signature>
      <path>src/app/api/categories/route.ts</path>
      <details>
        Current implementation: Returns categories filtered by type, sorted alphabetically.

        NEW FEATURE (Story 4-5): Add query parameter 'recent=true'

        When recent=true:
        1. Query last 5 distinct category_ids from transactions table:
           SELECT DISTINCT category_id, MAX(created_at) as last_used
           FROM transactions
           WHERE user_id = $1
           GROUP BY category_id
           ORDER BY last_used DESC
           LIMIT 5

        2. JOIN with categories table to get full category details

        3. Return TWO arrays in response:
           {
             data: Category[] (all categories, alphabetical),
             recent: Category[] (5 most recent, ordered by usage)
           }

        4. If no transactions exist, recent array is empty []

        Performance: Use existing indexes on transactions(user_id, created_at)
      </details>
    </interface>
    <interface>
      <name>CategoryMenu recentCategories prop</name>
      <kind>React component prop</kind>
      <signature>recentCategories?: Category[]</signature>
      <path>src/components/categories/CategoryMenu.tsx</path>
      <details>
        Already implemented in Story 4-4!

        CategoryMenu component accepts optional recentCategories prop.
        When provided, displays "Recently Used" section at top with divider.
        Each item rendered with CategoryBadge (color dot + name).

        TransactionEntryModal needs to:
        1. Fetch recent categories from API (separate SWR call or enhanced endpoint)
        2. Pass as recentCategories={recentData} prop to CategoryMenu

        Example:
        const { data: categoriesData } = useSWR(`/api/categories?type=${type}&recent=true`);
        &lt;CategoryMenu
          categories={categoriesData?.data || []}
          recentCategories={categoriesData?.recent || []}
        /&gt;
      </details>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Project follows manual testing + static analysis approach. TypeScript strict mode compilation (tsc --noEmit) and ESLint validation (next lint) required before marking story complete. No automated test framework configured.
    </standards>
    <locations>
      N/A - No automated test files currently. Manual testing workflow documented in story acceptance criteria.
    </locations>
    <ideas>
      <idea ac="AC1">Test modal shows 5 most recent categories at top when user has transaction history</idea>
      <idea ac="AC2">"Recent" section label displayed with divider below (CategoryMenu already has this)</idea>
      <idea ac="AC3">Verify categories ordered by transaction created_at DESC, not alphabetically</idea>
      <idea ac="AC4">Verify color dots (8px) displayed via CategoryBadge in recent section</idea>
      <idea ac="AC5">"All Categories" section below shows full alphabetical list</idea>
      <idea ac="AC6">Both predefined and custom categories appear in All section</idea>
      <idea ac="AC7">Edge case: User with 3 transactions shows only 3 recent categories (not 5)</idea>
      <idea ac="AC8">Edge case: New user with 0 transactions shows NO recent section, only All Categories</idea>
      <idea ac="AC9">After creating transaction, close modal and reopen - recent categories list updated</idea>
      <idea ac="AC10">Verify recent list computed from transactions table, not stored separately</idea>
      <idea ac="AC11">Selecting recent category works identically to selecting from All section</idea>
      <idea ac="AC12">Hover states consistent between recent and all sections (CategoryMenu handles this)</idea>
      <idea ac="AC13">Mobile: Menu items 44px height (already implemented in CategoryMenu)</idea>
      <idea ac="AC14">Keyboard: Arrow keys navigate within sections, Tab moves between (Chakra Menu default)</idea>
      <idea ac="AC15">Performance: Query execution time &lt; 100ms (use EXPLAIN ANALYZE on Supabase)</idea>
    </ideas>
  </tests>
</story-context>
